<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Echo Coffee</title>
    <link rel="stylesheet" href="style.css">
    <script src="scripts/masonry.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.0.0/imagesloaded.pkgd.min.js"></script>
</head>

<body>
    <div id="top">

        <div class="widthWrap widest">
            <h1>2902 N 68th St <br />Scottsdale, AZ 85251</h1>
            <h2>(480) 422-4081</h2>
            <div id="echo">
                <h1>Echo Coffee</h1></div>

        </div>
        <div class="clearFix"></div>

        <div id="navStick" class="navBar widthWrap">
            <nav>

                <ul>
                    <li><span class="dgrey">Home</span>
                        <ul>
                            <li>About</li>
                            <li>Drinks</li>
                            <li>Eats</li>
                            <li>What's new</li>
                            <li>Contact</li>
                        </ul>
                    </li>
                    <li><span class="dgrey">News</span></li>
                </ul>

            </nav>
        </div>
    </div>
    <div id="mastHead">
        <div id="mastHeadContent">
            <!--           <div id="logo"></div>-->
            <h1>
               
           </h1>
        </div>

    </div>
    <div id="navUnStick" class="navBar widthWrap">
        <nav>

            <ul>
                <li><span class="dgrey">Home</span>
                    <ul>
                        <li>About</li>
                        <li>Drinks</li>
                        <li>Eats</li>
                        <li>What's new</li>
                        <li>Contact</li>
                    </ul>
                </li>
                <li><span class="dgrey">News</span></li>
            </ul>

        </nav>
    </div>
    <div id="welcome" class="widthWrap medium">
        <h3>Welcome</h3>
        <p id="intro">Echo Coffee is a micro coffee roaster and coffee shop which seeks to provide a setting for great coffee in a friendly setting that promotes community, while serving fresh, organic products. WiFi is free, and there are numerous seating choices to match your mood.</p>
    </div>
    <div id="posts" class="widthWrap widest grid js-masonry" data-masonry-options='{ "itemSelector": ".post", "columnWidth": 445 }'>
        <span id="loading"> Give us a minute while we load more information.</span>

    </div>
    <!--Give us some breathing room just to test parallaxing-->

    <script>
        /* Sticky nav */
        var h = document.getElementById("navUnStick");
        var j = document.getElementById("navStick")
        var k = document.getElementById("echo")
        var stuck = false;
        var stickPoint = getDistance();
        var top = document.getElementById("top");

        function getDistance() {
            var topDist = h.offsetTop;
            return topDist;
        }

        window.onscroll = function (e) {
            var distance = getDistance() - (window.pageYOffset + 80);
            var offset = window.pageYOffset;
            if ((distance <= 0) && !stuck) {
                k.style.opacity = 1;
                j.style.display = 'block';
                h.style.display = 'hidden';
                k.style.top = '50px';
                stuck = true;
            } else if (stuck && (offset <= (stickPoint - 80))) {
                j.style.display = 'none';
                h.style.display = 'block';
                stuck = false;
                k.style.opacity = 0;
                k.style.top = '55px';
            }
        }


        /* Load posts */
        var xmlhttp = new XMLHttpRequest();
        var postURL = "http://chuckdries.com/blog/wp-json/wp/v2/posts";
        var mediaBaseURL = "http://chuckdries.com/blog/wp-json/wp/v2/media";
        xmlhttp.addEventListener("load", loadPosts); //event listener
        xmlhttp.open("GET", postURL); //load the master events list
        xmlhttp.send();
        var postList = [];
        var xmlHTTPMediaLoaders = [];
        var msnry;
        var grid = document.querySelector('.grid');
        msnry = new Masonry(grid, {
            itemSelector: '.post'
                //            columnWidth: 300
        });

        function loadPosts() { //triggers when we get the master events list back
            postList = JSON.parse(this.responseText);
            for (post in postList) {
                //http://stackoverflow.com/questions/14004117/create-div-and-append-div-dynamically
                var postDiv = document.createElement('div');
                postDiv.id = "p" + postList[post].id;
                postDiv.className = 'post';
                document.getElementById("posts").appendChild(postDiv);
                msnry.appended(postDiv);
                document.getElementById("p" + postList[post].id).innerHTML = "<div id=\"image-" + postDiv.id + "\" class = \"postImage grid-item\" ></div> <h3 class=\"postTitle\">" + postList[post].title.rendered + "</h3> <p class=\"postContent\">" + postList[post].content.rendered + "</p>";
            }

            listenForMedia();
        }

        function listenForMedia() {
            xmlhttp.removeEventListener("load", loadPosts);
            for (post in postList) {
                var mediaURL = mediaBaseURL + "/" + postList[post].featured_image;
                xmlHTTPMediaLoaders.push(new XMLHttpRequest());
                console.log(post);
                xmlHTTPMediaLoaders[post].addEventListener("load", function(){
                    loadImages( this.responseText);
                } );


                //Ideally I could pass the post variable to each loadImages somehow so I don't have to use a for loop on line 94
                xmlHTTPMediaLoaders[post].open("GET", mediaURL); //load the master events list
                xmlHTTPMediaLoaders[post].send();
            }
        }

        function loadImages(rt) {
            var imagesList = JSON.parse(rt);
            var postImage = document.createElement('img');
            for (post in postList) {
                var imageID = postList[post].featured_image;
                if (imagesList.id == imageID) {
                    var postDiv = document.getElementById("p" + postList[post].id);
                    var imageDiv = document.getElementById("image-" + postDiv.id);
                    var backgroundURL = imagesList.source_url;

                    postImage.src = backgroundURL;
                    imageDiv.appendChild(postImage);
                    //                    imageDiv.style.backgroundImage = "url('" + backgroundURL + "')";
                    xmlHTTPMediaLoaders[post].removeEventListener("load", loadImages);

                }
            }
            imagesLoaded('.grid', function () {
                // layout Masonry after each image loads
                msnry.layout();
                document.getElementById("loading").style.display = "none";
            });
        }
    </script>
</body>

</html>