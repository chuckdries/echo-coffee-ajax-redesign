<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Echo Coffee</title>
    <link rel="stylesheet" href="style.css">
    <script src="scripts/masonry.pkgd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.0.0/imagesloaded.pkgd.min.js"></script>
</head>

<body>
    <div id="top">

        <div class="widthWrap widest">
            <h1>2902 N 68th St <br />Scottsdale, AZ 85251</h1>
            <h2>(480) 422-4081</h2>
        </div>

    </div>
    <div id="mastHead">
        <div id="mastHeadContent">
            <!--           <div id="logo"></div>-->
            <h1>
               
           </h1>
        </div>

    </div>
    <div id="navStick" class="widthWrap">
        <nav>

            <ul>
                <li><span class="dgrey">Home:</span>
                    <ul>
                        <li>About</li>
                        <li>Drinks</li>
                        <li>Eats</li>
                        <li>What's new</li>
                        <li>Contact</li>
                    </ul>
                </li>
                <li><span class="dgrey">News</span></li>
            </ul>

        </nav>
    </div>
    <div id="posts" class="widthWrap widest grid js-masonry" data-masonry-options='{ "itemSelector": ".post", "columnWidth": 445 }'>
        <p id="loading">Loading posts...</p>
    </div>
    <!--Give us some breathing room just to test parallaxing-->
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <script>
        var xmlhttp = new XMLHttpRequest();
        var postURL = "http://chuckdries.com/blog/wp-json/wp/v2/posts";
        var mediaBaseURL = "http://chuckdries.com/blog/wp-json/wp/v2/media";
        xmlhttp.addEventListener("load", loadPosts); //event listener
        xmlhttp.open("GET", postURL); //load the master events list
        xmlhttp.send();
        var postList = [];
        var xmlHTTPMediaLoaders = [];
        var msnry;
        var grid = document.querySelector('.grid');
        msnry = new Masonry(grid, {
            itemSelector: '.post',
            columnWidth: 450
        });

        function loadPosts() { //triggers when we get the master events list back
            postList = JSON.parse(this.responseText);


            for (post in postList) {

                //http://stackoverflow.com/questions/14004117/create-div-and-append-div-dynamically
                var postDiv = document.createElement('div');
                //var eventContain = 
                postDiv.id = "p" + postList[post].id;
                postDiv.className = 'post';
//                postDiv.style.display = "none";
                if (post % 2 != 0) {
                    //                   postDiv.style.float = "right";
                }
                document.getElementById("posts").appendChild(postDiv);
                msnry.appended(postDiv);
                document.getElementById("p" + postList[post].id).innerHTML = "<div id=\"image-" + postDiv.id + "\" class = \"postImage grid-item\" ></div> <h3 class=\"postTitle\">" + postList[post].title.rendered + "</h3> <p class=\"postContent\">" + postList[post].content.rendered + "</p>";


            }
            document.getElementById("loading").style.display = "none";
            listenForMedia();

            //            console.log(msnry);
        }

        function listenForMedia() {
            xmlhttp.removeEventListener("load", loadPosts);

            for (post in postList) {
                var mediaURL = mediaBaseURL + "/" + postList[post].featured_image;
                xmlHTTPMediaLoaders.push(new XMLHttpRequest());
                xmlHTTPMediaLoaders[post].addEventListener("load", loadImages);
                //Ideally I could pass the post variable to each loadImages somehow so I don't have to use a for loop on line 94
                xmlHTTPMediaLoaders[post].open("GET", mediaURL); //load the master events list
                xmlHTTPMediaLoaders[post].send();

            }

        }

        function loadImages() {
            var imagesList = JSON.parse(this.responseText);
            var postImage = document.createElement('img');
            for (post in postList) {
                var imageID = postList[post].featured_image;
                if (imagesList.id == imageID) {
                    var postDiv = document.getElementById("p" + postList[post].id);
                    var imageDiv = document.getElementById("image-" + postDiv.id);
                    var backgroundURL = imagesList.source_url;
                    console.log(backgroundURL);
                    postImage.src = backgroundURL;
                    imageDiv.appendChild(postImage);
                    //                    imageDiv.style.backgroundImage = "url('" + backgroundURL + "')";
                    xmlHTTPMediaLoaders[post].removeEventListener("load", loadImages);
                    postDiv.style.display = "block";
                    
                }
            }
            imagesLoaded('.grid', function () {
                // layout Masonry after each image loads
                msnry.layout();
            });



        }


        // external js: masonry.pkgd.js, imagesloaded.pkgd.js



        //        var elem = document.getElementByID("posts");
        //        var msnry = new Masonry(elem, {
        //            // options
        //            itemSelector: '.post',
        //        });
    </script>
</body>

</html>